name: "DEV DEPLOY"

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download SSH Key from S3
        run: |
          curl -O "${{ vars.EC2_PRIVATE_KEY }}"

      - name: List dir
        run: ls

      - name: Set permissions for the SSH key
        run: chmod 600 "${{ vars.DEPLOYER_KEY_NAME }}.pem"

      - name: Add EC2 Host Key
        run: |
          ssh-keyscan -H "ec2-${{ vars.EC2_HOST }}.sa-east-1.compute.amazonaws.com" >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          echo "Testando conexão SSH..."
          ssh -i "${{ vars.DEPLOYER_KEY_NAME }}.pem" "ec2-user@ec2-${{ vars.EC2_HOST }}.sa-east-1.compute.amazonaws.com" 'echo "Chave válida!"'
          if [ $? -ne 0 ]; then
            echo "A conexão SSH falhou. A chave pode ser inválida."
            exit 1
          else
            echo "A chave é válida, você pode prosseguir com a conexão."
          fi

      - name: Deploy to EC2
        run: |
          ssh -i "${{ vars.DEPLOYER_KEY_NAME }}.pem" "ec2-user@ec2-${{ vars.EC2_HOST }}.sa-east-1.compute.amazonaws.com" << 'EOF'
            # Comandos Docker que você deseja executar
            docker ps
          EOF
